define("jpegMeta",[],function(){var e={init:function(){var e={};this.JpegMeta=e,e.parseNum=function(t,n,r,i){var s,o,u=t===">";r===undefined&&(r=0),i===undefined&&(i=n.length-r);for(u?s=r:s=r+i-1;u?s<r+i:s>=r;u?s++:s--)o<<=8,o+=n.charCodeAt(s);return o},e.parseSnum=function(t,n,r,i){var s,o,u,a=t===">";r===undefined&&(r=0),i===undefined&&(i=n.length-r);for(a?s=r:s=r+i-1;a?s<r+i:s>=r;a?s++:s--)u===undefined&&(u=(n.charCodeAt(s)&128)===128),o<<=8,o+=u?~n.charCodeAt(s)&255:n.charCodeAt(s);return u&&(o+=1,o*=-1),o},e.Rational=function(t,n){return this.num=t,this.den=n||1,this},e.Rational.prototype.toString=function t(){return this.num===0?""+this.num:this.den===1?""+this.num:this.num===1?this.num+" / "+this.den:this.num/this.den},e.Rational.prototype.asFloat=function(){return this.num/this.den},e.MetaGroup=function(t,n){return this.fieldName=t,this.description=n,this.metaProps={},this},e.MetaGroup.prototype._addProperty=function(n,r,i){var s=new e.MetaProp(n,r,i);this[s.fieldName]=s,this.metaProps[s.fieldName]=s},e.MetaGroup.prototype.toString=function n(){return"[MetaGroup "+this.description+"]"},e.MetaProp=function(t,n,r){return this.fieldName=t,this.description=n,this.value=r,this},e.MetaProp.prototype.toString=function r(){return""+this.value},e.JpegFile=function(n,r){var i=this._SOS;this.metaGroups={},this._binary_data=n,this.filename=r;var s=0,o=0,u,a,f,l,c,h,p;if(this._binary_data.slice(0,2)!==this._SOI_MARKER)throw new Error("Doesn't look like a JPEG file. First two bytes are "+this._binary_data.charCodeAt(0)+","+this._binary_data.charCodeAt(1)+".");s+=2;while(s<this._binary_data.length){u=this._binary_data.charCodeAt(s++),a=this._binary_data.charCodeAt(s++),o=s;if(u!=this._DELIM)break;if(a===i)break;c=e.parseNum(">",this._binary_data,s,2),s+=c;while(s<this._binary_data.length){u=this._binary_data.charCodeAt(s++);if(u==this._DELIM){f=this._binary_data.charCodeAt(s++);if(f!=0){s-=2;break}}}l=s-o,this._markers[a]?(h=this._markers[a][0],p=this._markers[a][1]):(h="UNKN",p=undefined),p&&this[p](a,o+2)}if(this.general===undefined)throw Error("Invalid JPEG file.");return this},this.JpegMeta.JpegFile.prototype.toString=function(){return"[JpegFile "+this.filename+" "+this.general.type+" "+this.general.pixelWidth+"x"+this.general.pixelHeight+" Depth: "+this.general.depth+"]"},this.JpegMeta.JpegFile.prototype._SOI_MARKER="ÿØ",this.JpegMeta.JpegFile.prototype._DELIM=255,this.JpegMeta.JpegFile.prototype._EOI=217,this.JpegMeta.JpegFile.prototype._SOS=218,this.JpegMeta.JpegFile.prototype._sofHandler=function(n,r){if(this.general!==undefined)throw Error("Unexpected multiple-frame image");this._addMetaGroup("general","General"),this.general._addProperty("depth","Depth",e.parseNum(">",this._binary_data,r,1)),this.general._addProperty("pixelHeight","Pixel Height",e.parseNum(">",this._binary_data,r+1,2)),this.general._addProperty("pixelWidth","Pixel Width",e.parseNum(">",this._binary_data,r+3,2)),this.general._addProperty("type","Type",this._markers[n][2])},this.JpegMeta.JpegFile.prototype._JFIF_IDENT="JFIF\0",this.JpegMeta.JpegFile.prototype._JFXX_IDENT="JFXX\0",this.JpegMeta.JpegFile.prototype._EXIF_IDENT="Exif\0",this.JpegMeta.JpegFile.prototype._types={1:["BYTE",1],2:["ASCII",1],3:["SHORT",2],4:["LONG",4],5:["RATIONAL",8],6:["SBYTE",1],7:["UNDEFINED",1],8:["SSHORT",2],9:["SLONG",4],10:["SRATIONAL",8],11:["FLOAT",4],12:["DOUBLE",8]},this.JpegMeta.JpegFile.prototype._tifftags={256:["Image width","ImageWidth"],257:["Image height","ImageLength"],258:["Number of bits per component","BitsPerSample"],259:["Compression scheme","Compression",{1:"uncompressed",6:"JPEG compression"}],262:["Pixel composition","PhotmetricInerpretation",{2:"RGB",6:"YCbCr"}],274:["Orientation of image","Orientation",{1:"Normal",2:"Reverse?",3:"Upside-down",4:"Upside-down Reverse",5:"90 degree CW",6:"90 degree CW reverse",7:"90 degree CCW",8:"90 degree CCW reverse"}],277:["Number of components","SamplesPerPixel"],284:["Image data arrangement","PlanarConfiguration",{1:"chunky format",2:"planar format"}],530:["Subsampling ratio of Y to C","YCbCrSubSampling"],531:["Y and C positioning","YCbCrPositioning",{1:"centered",2:"co-sited"}],282:["X Resolution","XResolution"],283:["Y Resolution","YResolution"],296:["Resolution Unit","ResolutionUnit",{2:"inches",3:"centimeters"}],273:["Image data location","StripOffsets"],278:["Number of rows per strip","RowsPerStrip"],279:["Bytes per compressed strip","StripByteCounts"],513:["Offset to JPEG SOI","JPEGInterchangeFormat"],514:["Bytes of JPEG Data","JPEGInterchangeFormatLength"],301:["Transfer function","TransferFunction"],318:["White point chromaticity","WhitePoint"],319:["Chromaticities of primaries","PrimaryChromaticities"],529:["Color space transformation matrix coefficients","YCbCrCoefficients"],532:["Pair of black and white reference values","ReferenceBlackWhite"],306:["Date and time","DateTime"],270:["Image title","ImageDescription"],271:["Make","Make"],272:["Model","Model"],305:["Software","Software"],315:["Person who created the image","Artist"],316:["Host Computer","HostComputer"],33432:["Copyright holder","Copyright"],34665:["Exif tag","ExifIfdPointer"],34853:["GPS tag","GPSInfoIfdPointer"]},this.JpegMeta.JpegFile.prototype._exiftags={36864:["Exif Version","ExifVersion"],40960:["FlashPix Version","FlashpixVersion"],40961:["Color Space","ColorSpace"],37121:["Meaning of each component","ComponentsConfiguration"],37122:["Compressed Bits Per Pixel","CompressedBitsPerPixel"],40962:["Pixel X Dimension","PixelXDimension"],40963:["Pixel Y Dimension","PixelYDimension"],37500:["Manufacturer notes","MakerNote"],37510:["User comments","UserComment"],40964:["Related audio file","RelatedSoundFile"],36867:["Date Time Original","DateTimeOriginal"],36868:["Date Time Digitized","DateTimeDigitized"],37520:["DateTime subseconds","SubSecTime"],37521:["DateTimeOriginal subseconds","SubSecTimeOriginal"],37522:["DateTimeDigitized subseconds","SubSecTimeDigitized"],33434:["Exposure time","ExposureTime"],33437:["FNumber","FNumber"],34850:["Exposure program","ExposureProgram"],34852:["Spectral sensitivity","SpectralSensitivity"],34855:["ISO Speed Ratings","ISOSpeedRatings"],34856:["Optoelectric coefficient","OECF"],37377:["Shutter Speed","ShutterSpeedValue"],37378:["Aperture Value","ApertureValue"],37379:["Brightness","BrightnessValue"],37380:["Exposure Bias Value","ExposureBiasValue"],37381:["Max Aperture Value","MaxApertureValue"],37382:["Subject Distance","SubjectDistance"],37383:["Metering Mode","MeteringMode"],37384:["Light Source","LightSource"],37385:["Flash","Flash"],37386:["Focal Length","FocalLength"],37396:["Subject Area","SubjectArea"],41483:["Flash Energy","FlashEnergy"],41484:["Spatial Frequency Response","SpatialFrequencyResponse"],41486:["Focal Plane X Resolution","FocalPlaneXResolution"],41487:["Focal Plane Y Resolution","FocalPlaneYResolution"],41488:["Focal Plane Resolution Unit","FocalPlaneResolutionUnit"],41492:["Subject Location","SubjectLocation"],41493:["Exposure Index","ExposureIndex"],41495:["Sensing Method","SensingMethod"],41728:["File Source","FileSource"],41729:["Scene Type","SceneType"],41730:["CFA Pattern","CFAPattern"],41985:["Custom Rendered","CustomRendered"],41986:["Exposure Mode","Exposure Mode"],41987:["White Balance","WhiteBalance"],41988:["Digital Zoom Ratio","DigitalZoomRatio"],41990:["Scene Capture Type","SceneCaptureType"],41991:["Gain Control","GainControl"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["Device settings description","DeviceSettingDescription"],41996:["Subject distance range","SubjectDistanceRange"],42016:["Unique image ID","ImageUniqueID"],40965:["Interoperability tag","InteroperabilityIFDPointer"]},this.JpegMeta.JpegFile.prototype._gpstags={0:["GPS tag version","GPSVersionID"],1:["North or South Latitude","GPSLatitudeRef"],2:["Latitude","GPSLatitude"],3:["East or West Longitude","GPSLongitudeRef"],4:["Longitude","GPSLongitude"],5:["Altitude reference","GPSAltitudeRef"],6:["Altitude","GPSAltitude"],7:["GPS time (atomic clock)","GPSTimeStamp"],8:["GPS satellites usedd for measurement","GPSSatellites"],9:["GPS receiver status","GPSStatus"],10:["GPS mesaurement mode","GPSMeasureMode"],11:["Measurement precision","GPSDOP"],12:["Speed unit","GPSSpeedRef"],13:["Speed of GPS receiver","GPSSpeed"],14:["Reference for direction of movement","GPSTrackRef"],15:["Direction of movement","GPSTrack"],16:["Reference for direction of image","GPSImgDirectionRef"],17:["Direction of image","GPSImgDirection"],18:["Geodetic survey data used","GPSMapDatum"],19:["Reference for latitude of destination","GPSDestLatitudeRef"],20:["Latitude of destination","GPSDestLatitude"],21:["Reference for longitude of destination","GPSDestLongitudeRef"],22:["Longitude of destination","GPSDestLongitude"],23:["Reference for bearing of destination","GPSDestBearingRef"],24:["Bearing of destination","GPSDestBearing"],25:["Reference for distance to destination","GPSDestDistanceRef"],26:["Distance to destination","GPSDestDistance"],27:["Name of GPS processing method","GPSProcessingMethod"],28:["Name of GPS area","GPSAreaInformation"],29:["GPS Date","GPSDateStamp"],30:["GPS differential correction","GPSDifferential"]},this.JpegMeta.JpegFile.prototype._markers={192:["SOF0","_sofHandler","Baseline DCT"],193:["SOF1","_sofHandler","Extended sequential DCT"],194:["SOF2","_sofHandler","Progressive DCT"],195:["SOF3","_sofHandler","Lossless (sequential)"],197:["SOF5","_sofHandler","Differential sequential DCT"],198:["SOF6","_sofHandler","Differential progressive DCT"],199:["SOF7","_sofHandler","Differential lossless (sequential)"],200:["JPG",null,"Reserved for JPEG extensions"],201:["SOF9","_sofHandler","Extended sequential DCT"],202:["SOF10","_sofHandler","Progressive DCT"],203:["SOF11","_sofHandler","Lossless (sequential)"],205:["SOF13","_sofHandler","Differential sequential DCT"],206:["SOF14","_sofHandler","Differential progressive DCT"],207:["SOF15","_sofHandler","Differential lossless (sequential)"],196:["DHT",null,"Define Huffman table(s)"],204:["DAC",null,"Define arithmetic coding conditioning(s)"],208:["RST0",null,"Restart with modulo 8 count “0”"],209:["RST1",null,"Restart with modulo 8 count “1”"],210:["RST2",null,"Restart with modulo 8 count “2”"],211:["RST3",null,"Restart with modulo 8 count “3”"],212:["RST4",null,"Restart with modulo 8 count “4”"],213:["RST5",null,"Restart with modulo 8 count “5”"],214:["RST6",null,"Restart with modulo 8 count “6”"],215:["RST7",null,"Restart with modulo 8 count “7”"],216:["SOI",null,"Start of image"],217:["EOI",null,"End of image"],218:["SOS",null,"Start of scan"],219:["DQT",null,"Define quantization table(s)"],220:["DNL",null,"Define number of lines"],221:["DRI",null,"Define restart interval"],222:["DHP",null,"Define hierarchical progression"],223:["EXP",null,"Expand reference component(s)"],224:["APP0","_app0Handler","Reserved for application segments"],225:["APP1","_app1Handler"],226:["APP2",null],227:["APP3",null],228:["APP4",null],229:["APP5",null],230:["APP6",null],231:["APP7",null],232:["APP8",null],233:["APP9",null],234:["APP10",null],235:["APP11",null],236:["APP12",null],237:["APP13",null],238:["APP14",null],239:["APP15",null],240:["JPG0",null],241:["JPG1",null],242:["JPG2",null],243:["JPG3",null],244:["JPG4",null],245:["JPG5",null],246:["JPG6",null],247:["JPG7",null],248:["JPG8",null],249:["JPG9",null],250:["JPG10",null],251:["JPG11",null],252:["JPG12",null],253:["JPG13",null],254:["COM",null],1:["JPG13",null]},this.JpegMeta.JpegFile.prototype._addMetaGroup=function(n,r){var i=new e.MetaGroup(n,r);return this[i.fieldName]=i,this.metaGroups[i.fieldName]=i,i},this.JpegMeta.JpegFile.prototype._parseIfd=function(n,r,i,s,o,u,a){var l=e.parseNum(n,r,i+s,2),c,h,p,d,v,m,g,y,b,w,E,S,x,T;T=this._addMetaGroup(u,a);for(var c=0;c<l;c++){p=i+s+2+c*12,d=e.parseNum(n,r,p,2),m=e.parseNum(n,r,p+2,2),y=e.parseNum(n,r,p+4,4),b=e.parseNum(n,r,p+8,4);if(this._types[m]===undefined)continue;v=this._types[m][0],g=this._types[m][1],g*y<=4?b=p+8:b=i+b;if(v=="UNDEFINED")f=r.slice(b,b+y);else if(v=="ASCII")w=r.slice(b,b+y),w=w.split("\0")[0];else{w=new Array;for(h=0;h<y;h++,b+=g)(v=="BYTE"||v=="SHORT"||v=="LONG")&&w.push(e.parseNum(n,r,b,g)),(v=="SBYTE"||v=="SSHORT"||v=="SLONG")&&w.push(e.parseSnum(n,r,b,g)),v=="RATIONAL"&&(S=e.parseNum(n,r,b,4),x=e.parseNum(n,r,b+4,4),w.push(new e.Rational(S,x))),v=="SRATIONAL"&&(S=e.parseSnum(n,r,b,4),x=e.parseSnum(n,r,b+4,4),w.push(new e.Rational(S,x))),w.push();y===1&&(w=w[0])}o[d]!==undefined&&T._addProperty(o[d][1],o[d][0],w)}},this.JpegMeta.JpegFile.prototype._jfifHandler=function(n,r){if(this.jfif!==undefined)throw Error("Multiple JFIF segments found");this._addMetaGroup("jfif","JFIF"),this.jfif._addProperty("version_major","Version Major",this._binary_data.charCodeAt(r+5)),this.jfif._addProperty("version_minor","Version Minor",this._binary_data.charCodeAt(r+6)),this.jfif._addProperty("version","JFIF Version",this.jfif.version_major.value+"."+this.jfif.version_minor.value),this.jfif._addProperty("units","Density Unit",this._binary_data.charCodeAt(r+7)),this.jfif._addProperty("Xdensity","X density",e.parseNum(">",this._binary_data,r+8,2)),this.jfif._addProperty("Ydensity","Y Density",e.parseNum(">",this._binary_data,r+10,2)),this.jfif._addProperty("Xthumbnail","X Thumbnail",e.parseNum(">",this._binary_data,r+12,1)),this.jfif._addProperty("Ythumbnail","Y Thumbnail",e.parseNum(">",this._binary_data,r+13,1))},this.JpegMeta.JpegFile.prototype._app0Handler=function(t,n){var r=this._binary_data.slice(n,n+5);r==this._JFIF_IDENT?this._jfifHandler(t,n):r==this._JFXX_IDENT},this.JpegMeta.JpegFile.prototype._app1Handler=function(t,n){var r=this._binary_data.slice(n,n+5);r==this._EXIF_IDENT&&this._exifHandler(t,n+6)},e.JpegFile.prototype._exifHandler=function(n,r){if(this.exif!==undefined)throw new Error("Multiple JFIF segments found");var i,s,o,u,a,f,l=this._binary_data.slice(r,r+2);if(l==="II")i="<";else{if(l!=="MM")throw new Error("Malformed TIFF meta-data. Unknown endianess: "+l);i=">"}s=e.parseNum(i,this._binary_data,r+2,2);if(s!==42)throw new Error("Malformed TIFF meta-data. Bad magic: "+s);o=e.parseNum(i,this._binary_data,r+4,4),this._parseIfd(i,this._binary_data,r,o,this._tifftags,"tiff","TIFF"),this.tiff.ExifIfdPointer&&this._parseIfd(i,this._binary_data,r,this.tiff.ExifIfdPointer.value,this._exiftags,"exif","Exif");if(this.tiff.GPSInfoIfdPointer){this._parseIfd(i,this._binary_data,r,this.tiff.GPSInfoIfdPointer.value,this._gpstags,"gps","GPS");if(this.gps.GPSLatitude){var c;c=this.gps.GPSLatitude.value[0].asFloat()+1/60*this.gps.GPSLatitude.value[1].asFloat()+1/3600*this.gps.GPSLatitude.value[2].asFloat(),this.gps.GPSLatitudeRef.value==="S"&&(c=-c),this.gps._addProperty("latitude","Dec. Latitude",c)}if(this.gps.GPSLongitude){var h;h=this.gps.GPSLongitude.value[0].asFloat()+1/60*this.gps.GPSLongitude.value[1].asFloat()+1/3600*this.gps.GPSLongitude.value[2].asFloat(),this.gps.GPSLongitudeRef.value==="W"&&(h=-h),this.gps._addProperty("longitude","Dec. Longitude",h)}}}}};return e.init(),e.JpegMeta}),define("JPEGEncoder",[],function(){var e={JPEGEncoder:function(e){function P(e){var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99];for(var n=0;n<64;n++){var a=r((t[n]*e+50)/100);a<1?a=1:a>255&&(a=255),i[N[n]]=a}var f=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99];for(var l=0;l<64;l++){var c=r((f[l]*e+50)/100);c<1?c=1:c>255&&(c=255),s[N[l]]=c}var h=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],p=0;for(var d=0;d<8;d++)for(var v=0;v<8;v++)o[p]=1/(i[N[p]]*h[d]*h[v]*8),u[p]=1/(s[N[p]]*h[d]*h[v]*8),p++}function H(e,t){var n=0,r=0,i=new Array;for(var s=1;s<=16;s++){for(var o=1;o<=e[s];o++)i[t[r]]=[],i[t[r]][0]=n,i[t[r]][1]=s,r++,n++;n*=2}return i}function B(){a=H(C,k),f=H(O,M),l=H(L,A),c=H(_,D)}function j(){var e=1,t=2;for(var n=1;n<=15;n++){for(var r=e;r<t;r++)p[32767+r]=n,h[32767+r]=[],h[32767+r][1]=n,h[32767+r][0]=r;for(var i=-(t-1);i<=-e;i++)p[32767+i]=n,h[32767+i]=[],h[32767+i][1]=n,h[32767+i][0]=t-1+i;e<<=1,t<<=1}}function F(){for(var e=0;e<256;e++)x[e]=19595*e,x[e+256>>0]=38470*e,x[e+512>>0]=7471*e+32768,x[e+768>>0]=-11059*e,x[e+1024>>0]=-21709*e,x[e+1280>>0]=32768*e+8421375,x[e+1536>>0]=-27439*e,x[e+1792>>0]=-5329*e}function I(e){var t=e[0],n=e[1]-1;while(n>=0)t&1<<n&&(g|=1<<y),n--,y--,y<0&&(g==255?(q(255),q(0)):q(g),y=7,g=0)}function q(e){m.push(S[e])}function R(e){q(e>>8&255),q(e&255)}function U(e,t){var n,r,i,s,o,u,a,f,l=0,c;const h=8,p=64;for(c=0;c<h;++c){n=e[l],r=e[l+1],i=e[l+2],s=e[l+3],o=e[l+4],u=e[l+5],a=e[l+6],f=e[l+7];var v=n+f,m=n-f,g=r+a,y=r-a,b=i+u,w=i-u,E=s+o,S=s-o,x=v+E,T=v-E,N=g+b,C=g-b;e[l]=x+N,e[l+4]=x-N;var k=(C+T)*.707106781;e[l+2]=T+k,e[l+6]=T-k,x=S+w,N=w+y,C=y+m;var L=(x-C)*.382683433,A=.5411961*x+L,O=1.306562965*C+L,M=N*.707106781,_=m+M,D=m-M;e[l+5]=D+A,e[l+3]=D-A,e[l+1]=_+O,e[l+7]=_-O,l+=8}l=0;for(c=0;c<h;++c){n=e[l],r=e[l+8],i=e[l+16],s=e[l+24],o=e[l+32],u=e[l+40],a=e[l+48],f=e[l+56];var P=n+f,H=n-f,B=r+a,j=r-a,F=i+u,I=i-u,q=s+o,R=s-o,U=P+q,z=P-q,W=B+F,X=B-F;e[l]=U+W,e[l+32]=U-W;var V=(X+z)*.707106781;e[l+16]=z+V,e[l+48]=z-V,U=R+I,W=I+j,X=j+H;var $=(U-X)*.382683433,J=.5411961*U+$,K=1.306562965*X+$,Q=W*.707106781,G=H+Q,Y=H-Q;e[l+40]=Y+J,e[l+24]=Y-J,e[l+8]=G+K,e[l+56]=G-K,l++}var Z;for(c=0;c<p;++c)Z=e[c]*t[c],d[c]=Z>0?Z+.5|0:Z-.5|0;return d}function z(){R(65504),R(16),q(74),q(70),q(73),q(70),q(0),q(1),q(1),q(0),R(1),R(1),q(0),q(0)}function W(e,t){R(65472),R(17),q(8),R(t),R(e),q(3),q(1),q(17),q(0),q(2),q(17),q(1),q(3),q(17),q(1)}function X(){R(65499),R(132),q(0);for(var e=0;e<64;e++)q(i[e]);q(1);for(var t=0;t<64;t++)q(s[t])}function V(){R(65476),R(418),q(0);for(var e=0;e<16;e++)q(C[e+1]);for(var t=0;t<=11;t++)q(k[t]);q(16);for(var n=0;n<16;n++)q(L[n+1]);for(var r=0;r<=161;r++)q(A[r]);q(1);for(var i=0;i<16;i++)q(O[i+1]);for(var s=0;s<=11;s++)q(M[s]);q(17);for(var o=0;o<16;o++)q(_[o+1]);for(var u=0;u<=161;u++)q(D[u])}function $(){R(65498),R(12),q(3),q(1),q(0),q(2),q(17),q(3),q(17),q(0),q(63),q(0)}function J(e,t,n,r,i){var s=i[0],o=i[240],u;const a=16,f=63,l=64;var c=U(e,t);for(var d=0;d<l;++d)v[N[d]]=c[d];var m=v[0]-n;n=v[0],m==0?I(r[0]):(u=32767+m,I(r[p[u]]),I(h[u]));var g=63;for(;g>0&&v[g]==0;g--);if(g==0)return I(s),n;var y=1,b;while(y<=g){var w=y;for(;v[y]==0&&y<=g;++y);var E=y-w;if(E>=a){b=E>>4;for(var S=1;S<=b;++S)I(o);E&=15}u=32767+v[y],I(i[(E<<4)+p[u]]),I(h[u]),y++}return g!=f&&I(s),n}function K(){var e=String.fromCharCode;for(var t=0;t<256;t++)S[t]=e(t)}function Q(e){e<=0&&(e=1),e>100&&(e=100);if(T==e)return;var t=0;e<50?t=Math.floor(5e3/e):t=Math.floor(200-e*2),P(t),T=e}function G(){var t=(new Date).getTime();e||(e=50),K(),B(),j(),F(),Q(e);var n=(new Date).getTime()-t}var t=this,n=Math.round,r=Math.floor,i=new Array(64),s=new Array(64),o=new Array(64),u=new Array(64),a,f,l,c,h=new Array(65535),p=new Array(65535),d=new Array(64),v=new Array(64),m=[],g=0,y=7,b=new Array(64),w=new Array(64),E=new Array(64),S=new Array(256),x=new Array(2048),T,N=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],C=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],k=[0,1,2,3,4,5,6,7,8,9,10,11],L=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],A=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],O=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],M=[0,1,2,3,4,5,6,7,8,9,10,11],_=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],D=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];this.encode=function(e,t){var n=(new Date).getTime();t&&Q(t),m=new Array,g=0,y=7,R(65496),z(),X(),W(e.width,e.height),V(),$();var r=0,i=0,s=0;g=0,y=7,this.encode.displayName="_encode_";var h=e.data,p=e.width,d=e.height,v=p*4,S=p*3,T,N=0,C,k,L,A,O,M,_,D;while(N<d){T=0;while(T<v){A=v*N+T,O=A,M=-1,_=0;for(D=0;D<64;D++)_=D>>3,M=(D&7)*4,O=A+_*v+M,N+_>=d&&(O-=v*(N+1+_-d)),T+M>=v&&(O-=T+M-v+4),C=h[O++],k=h[O++],L=h[O++],b[D]=(x[C]+x[k+256>>0]+x[L+512>>0]>>16)-128,w[D]=(x[C+768>>0]+x[k+1024>>0]+x[L+1280>>0]>>16)-128,E[D]=(x[C+1280>>0]+x[k+1536>>0]+x[L+1792>>0]>>16)-128;r=J(b,o,r,a,l),i=J(w,u,i,f,c),s=J(E,u,s,f,c),T+=32}N+=8}if(y>=0){var P=[];P[1]=y+1,P[0]=(1<<y+1)-1,I(P)}R(65497);var H="data:image/jpeg;base64,"+btoa(m.join(""));m=[];var B=(new Date).getTime()-n;return H},G()},getImageDataFromImage:function(e){var t=typeof e=="string"?document.getElementById(e):e,n=document.createElement("canvas");n.width=t.width,n.height=t.height;var r=n.getContext("2d");return r.drawImage(t,0,0),r.getImageData(0,0,n.width,n.height)}};return e}),define("imageCompresser",["jpegMeta","JPEGEncoder"],function(e,t){var n={init:function(){var e={isIosSubSample:function(e){var t=e.naturalWidth,n=e.naturalHeight,r=!1;if(t*n>1048576){var i=document.createElement("canvas");ctx=i.getContext("2d"),i.width=i.height=1,ctx.drawImage(e,1-t,0),r=ctx.getImageData(0,0,1,1).data[3]===0,i=ctx=null}return r},getIosImageRatio:function(e,t,n){var r=document.createElement("canvas"),i=r.getContext("2d"),s,o=0,u=n,a=n;r.width=1,r.height=n,i.drawImage(e,1-Math.ceil(Math.random()*t),0),s=i.getImageData(0,0,1,n).data;while(a>o){var f=s[(a-1)*4+3];f===0?u=a:o=a,a=u+o>>1}return a/n},getImageBase64:function(n,r){r=jQuery.extend({maxW:800,maxH:800,quality:.8,orien:1},r);var i=r.maxW,s=r.maxW,o=r.quality,u=n.naturalWidth,a=n.naturalHeight,f,l;jq.os.ios&&e.isIosSubSample(n)&&(u/=2,a/=2),u>i&&u/a>=i/s?(f=i,l=a*i/u):a>s&&a/u>=s/i?(f=u*s/a,l=s):(f=u,l=a);var c=document.createElement("canvas"),h=c.getContext("2d"),p;this.doAutoRotate(c,f,l,r.orien);if(jq.os.ios){var d=document.createElement("canvas"),v=d.getContext("2d"),m=1024,g=e.getIosImageRatio(n,u,a),y,b,w,E,S,x,T,N;d.width=d.height=m,b=0;while(b<a){E=b+m>a?a-b:m,y=0;while(y<u)w=y+m>u?u-y:m,v.clearRect(0,0,m,m),v.drawImage(n,-y,-b),S=Math.floor(y*f/u),T=Math.ceil(w*f/u),x=Math.floor(b*l/a/g),N=Math.ceil(E*l/a/g),h.drawImage(d,0,0,w,E,S,x,T,N),y+=m;b+=m}d=v=null}else h.drawImage(n,0,0,u,a,0,0,f,l);if(jq.os.android){var C=h.getImageData(0,0,c.width,c.height),k=new t.JPEGEncoder(o*100);p=k.encode(C),k=null}else p=c.toDataURL("image/jpeg",o);return c=h=null,p},doAutoRotate:function(e,t,n,r){var i=e.getContext("2d");r>=5&&r<=8?(e.width=n,e.height=t):(e.width=t,e.height=n);switch(r){case 2:i.translate(t,0),i.scale(-1,1);break;case 3:i.translate(t,n),i.rotate(Math.PI);break;case 4:i.translate(0,n),i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI),i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI),i.translate(0,-n);break;case 7:i.rotate(.5*Math.PI),i.translate(t,-n),i.scale(-1,1);break;case 8:i.rotate(-0.5*Math.PI),i.translate(-t,0);break;default:}},getFileObjectURL:function(e){var t=window.URL||window.webkitURL||!1;if(t)return t.createObjectURL(e)},support:function(){return typeof window.File&&typeof window.FileList&&typeof window.FileReader&&typeof window.Blob}};this.ImageCompresser=e}};return n.init(),n}),define("uploadImg",["jpegMeta","imageCompresser"],function(e,t){var n={maxUpload:8,uploadInfo:{},uploadQueue:[],previewQueue:[],xhr:{},isBusy:!1,countUpload:function(){var e=0;return jq.each(n.uploadInfo,function(t,n){n&&++e}),e},uploadPreview:function(r){var i=new FileReader,s,o={},u=n.uploadInfo[r].file;window.NETTYPE==window.NETTYPE_WIFI&&(o={maxW:3e3,maxH:1280,quality:.8}),i.onload=function(i){var a=this.result;if(u.type=="image/jpeg"){try{var f=new e.JpegFile(a,u.name)}catch(i){return jq.UTIL.dialog({content:"图片不是正确的图片数据",autoClose:!0}),jq("#li"+r).remove(),!1}f.tiff&&f.tiff.Orientation&&(o=jq.extend(o,{orien:f.tiff.Orientation.value}))}if(t.ImageCompresser.support()){var l=new Image;l.onload=function(){try{s=t.ImageCompresser.getImageBase64(this,o)}catch(e){return jq.UTIL.dialog({content:"压缩图片失败",autoClose:!0}),jq("#li"+r).remove(),!1}if(s.indexOf("data:image")<0)return jq.UTIL.dialog({content:"上传照片格式不支持",autoClose:!0}),jq("#li"+r).remove(),!1;n.uploadInfo[r].file=s,jq("#li"+r).find("img").attr("src",s),n.uploadQueue.push(r)},l.onerror=function(){return jq.UTIL.dialog({content:"解析图片数据失败",autoClose:!0}),jq("#li"+r).remove(),!1},l.src=t.ImageCompresser.getFileObjectURL(u)}else{s=a;if(s.indexOf("data:image")<0)return jq.UTIL.dialog({content:"上传照片格式不支持",autoClose:!0}),jq("#li"+r).remove(),!1;n.uploadInfo[r].file=s,jq("#li"+r).find("img").attr("src",s),n.uploadQueue.push(r)}},i.readAsBinaryString(n.uploadInfo[r].file)},createUpload:function(e,t,r){if(!n.uploadInfo[e])return!1;var i="http://upload.qiniu.com/putb64/-1/mimeType/aW1hZ2UvanBlZw==",s='<div class="progress brSmall pr" id="progress'+e+'"><div class="proBar" style="width:0%;"></div></div>';jq("#li"+e).find(".maskLay").after(s);var o=function(t){if(t.target.response){var i=jq.parseJSON(t.target.response);if(!("key"in i))return jq.UTIL.dialog({content:"网络不稳定，请稍后重新操作",autoClose:!0}),u(e),n.uploadRemaining(),!1}var s=jq("#progress"+e).find(".proBar");if(t.total==t.loaded)var o=100;else var o=100*(t.loaded/t.total);o>100&&(o=100),s.animate({width:"95%"},1500),setTimeout(function(){o==100&&r&&clearInterval(r)},400)},u=function(e){a(e),jq("#li"+e).remove()},a=function(e){n.isBusy=!1,typeof n.uploadInfo[e]!="undefined"&&(n.uploadInfo[e].isDone=!0),typeof n.xhr[e]!="undefined"&&(n.xhr[e]=null)},f=function(r){var i=jq("#progress"+e).find(".proBar");i.css("width","100%"),jq("#li"+e).find(".maskLay").remove(),jq("#li"+e).find(".progress").remove(),a(e);var s=jq.parseJSON(r.target.response);if("key"in s){var o='<input type="hidden" id="input'+e+'" name="pickeys" value="'+s.hash+'">';t=="replyForm"?jq("#replyForm").append(o):jq("#newthread").append(o)}else{jq.UTIL.dialog({content:"网络不稳定，请稍后重新操作",autoClose:!0}),u(e),n.uploadRemaining(),delete n.uploadInfo[e];if(n.countUpload()<n.maxUpload){var f=jq(".iconSendImg");jq("#addPic").show(),f.hasClass("fail")&&f.removeClass("fail")}}},l=function(){jq.UTIL.dialog({content:"网络断开，请稍后重新操作",autoClose:!0}),u(e)},c=function(){jq.UTIL.dialog({content:"上传已取消",autoClose:!0}),u(e)},h=function(t){n.xhr[e]=jq.UTIL.createCORSRequest("POST",i),n.xhr[e].setRequestHeader("Authorization","UpToken "+jq.parseJSON(t.target.response).token),n.xhr[e].addEventListener("progress",o,!1),n.xhr[e].upload.addEventListener("progress",o,!1),n.xhr[e].addEventListener("load",f,!1),n.xhr[e].addEventListener("abort",c,!1),n.xhr[e].addEventListener("error",l,!1),n.xhr[e].withCredentials=!1,n.xhr[e].send(n.uploadInfo[e].file.split(";base64,")[1])},p="/img/uptoken",d=jq.UTIL.createCORSRequest("GET",p);d.addEventListener("load",h,!1),d.addEventListener("abort",c,!1),d.addEventListener("error",l,!1),d.send()},checkUploadBySysVer:function(){return!jq.os.android&&jq.os.ios&&jq.os.version.toString()<"6.0"?(jq.UTIL.dialog({content:"手机系统不支持传图，请升级到ios6.0以上",autoClose:!0}),!1):jq.os.wx&&jq.os.wxVersion.toString()<"5.2"?(jq.UTIL.dialog({content:"当前微信版本不支持传图，请升级到最新版",autoClose:!0}),!1):!0},uploadRemaining:function(){var e=0;e=jq(".photoList").find("li").length;var t=8;switch(e){case 1:t=8;break;case 2:t=7;break;case 3:t=6;break;case 4:t=5;break;case 5:t=4;break;case 6:t=3;break;case 7:t=2;break;case 8:t=1;break;case 9:t=0;break;default:t=8}},checkPicSize:function(e){return e.size>1e7?!1:!0},checkPicType:function(e){var t=/\.png$|\.bmp$|\.jpg$|\.jpeg$|\.gif$/i;return t.test(e.name)?!0:!1}};return n}),require(["uploadImg","util"],function(e,t){var n={contentHeight:0,uploadTimer:null,initUpload:function(){jq("#addPic").on("click",function(){if(!e.checkUploadBySysVer())return!1}),jq("#uploadFile, #fistUploadFile").on("click",function(){var t=jq(this);if(jq(".photoList").find("#livideo").length>0)return jq.UTIL.dialog({id:"addWsTips",content:"图片和微视只能发一种哦~",autoClose:2e3}),!1;if(e.isBusy)return jq.UTIL.dialog({content:"上传中，请稍后添加",autoClose:!0}),!1;if(t.attr("id")=="fistUploadFile"&&jq(".iconSendImg").hasClass("fail"))return jq.UTIL.dialog({content:"不能再上传了，最多只能上传8张图片哦~",autoClose:!0}),!1}),jq("body").on("click",".iconSendImg, .iconArrowR",function(e){var t=jq(this),n=jq(".photoList");t.hasClass("iconSendImg")&&n.is(":hidden")&&(jq(".sendCon").css("height","60"),n.show());if(t.hasClass("iconArrowR")){var r=jq(".expressionMenu").find("a"),i=r.length*76,s=jq(".expressionTab").width();if(i>s){var o=jq(r[0]);jq(".expressionMenu").append(o.clone()),o.remove()}else jq.UTIL.dialog({id:"haveMoreExpression",content:"没有更多表情了哦~",autoClose:!0})}}),jq("body").on("change","#fistUploadFile",function(e){var t=jq("#content")[0];jq(".photoList").show(),jq(".operatList").hide(),jq(".photoTipsBox").show(),jq(".operatIcon").removeClass("on"),jq(".iconSendImg").addClass("on"),t.scrollTop=t.scrollHeight}),jq("body").on("change","#uploadFile, #fistUploadFile",function(t){uploadTimer=setInterval(function(){setTimeout(function(){if(e.previewQueue.length){var t=e.previewQueue.shift();e.uploadPreview(t)}},1),setTimeout(function(){if(!e.isBusy&&e.uploadQueue.length){var t=e.uploadQueue.shift();e.isBusy=!0,e.createUpload(t,"newthread",uploadTimer),jq("#li"+t+" .cBtn").show()}},10)},300),t=t||window.event;var n=t.target.files;if(!n.length)return!1;for(var r=0;r<n.length;r++){if(e.countUpload()>=e.maxUpload){jq.UTIL.dialog({content:"最多只能上传8张图片",autoClose:!0});break}var i=n[r];if(!e.checkPicType(i)){jq.UTIL.dialog({content:"上传照片格式不支持",autoClose:!0});continue}if(!e.checkPicSize(i)){jq.UTIL.dialog({content:"图片体积过大",autoClose:!0});continue}var s=Date.now()+r;e.uploadInfo[s]={file:i,isDone:!1};var o='<li id="li'+s+'"><div class="photoCut"><img src="/static/img/defaultImg.png" class="attchImg" alt="photo"></div>'+'<div class="maskLay"></div>'+'<a href="javascript:;" class="cBtn cBtnOn pa db" style="display:none;" title="" _id="'+s+'">关闭</a></li>';jq("#addPic").before(o),e.previewQueue.push(s),e.countUpload()>=e.maxUpload&&(jq("#addPic").hide(),jq(".iconSendImg").addClass("fail")),setTimeout(function(){e.uploadRemaining()},400)}jq(this).val("")}),jq(".photoList").on("click",".cBtn",function(){var t=jq(this).attr("_id");e.xhr[t]&&e.xhr[t].abort(),jq("#li"+t).remove(),jq("#input"+t).remove(),e.uploadInfo[t]=null,t=="video"&&jq(".iconVideo").addClass("iconVideoOn"),t=="video"&&jq(".iconVideo").addClass("iconVideoOn"),e.countUpload()<e.maxUpload&&(jq("#addPic").show(),jq(".iconSendImg").removeClass("fail")),e.uploadRemaining(),jq(".photoList").find("li").length<2&&(jq(".photoList").hide(),jq(".sendCon").css("height",n.contentHeight))})},init:function(){n.contentHeight=jq(".sendCon").height();var t="topic_title",r="topic_content";jq("#title").val(localStorage.getItem(t)),jq("#content").val(localStorage.getItem(r)),timer=setInterval(function(){localStorage.removeItem(t),localStorage.setItem(t,jq("#title").val()),localStorage.removeItem(r),localStorage.setItem(r,jq("#content").val())},1e3);var i=!1;jq("#submitButton").bind("click",function(){if(e.isBusy)return jq.UTIL.dialog({content:"图片上传中，请稍候",autoClose:!0}),!1;if(i||!n.checkForm())return!1;var s={noMsg:!1,success:function(e){var n=parseInt(e.code);if(n==0)return clearInterval(timer),localStorage.removeItem(t),localStorage.removeItem(r),jq.UTIL.reload(e.jumpURL),!1;i=!1,jq.UTIL.dialog({content:e.msg,autoClose:!0})},error:function(e){i=!1},noJump:!0};return i=!0,jq.UTIL.ajaxForm("newthread",s,!0),!1}),n.initUpload(),n.initModal()},initModal:function(){jq("#submitButton").bind("touchstart",function(){jq(this).addClass("sendOn")}).bind("touchend",function(){jq(this).removeClass("sendOn")}),jq("#cBtn").bind("touchstart",function(){jq(this).addClass("cancelOn")}).bind("touchend",function(){jq(this).removeClass("cancelOn")})},checkForm:function(){jq.each(e.uploadInfo,function(e,t){if(t&&!t.isDone)return jq.UTIL.dialog({content:"图片上传中，请等待",autoClose:!0}),!1});var t=jq("#title").val(),n=jq.UTIL.mb_strlen(jq.UTIL.trim(t));if(n<7)return jq.UTIL.dialog({content:"话题字数有点少",autoClose:!0}),!1;if(n>180)return jq.UTIL.dialog({content:"话题最好不要超过60字，复杂话题可以在描述中说明",autoClose:!0}),!1;var r=jq("#content").val(),i=jq.UTIL.mb_strlen(jq.UTIL.trim(r));return i>3072?(jq.UTIL.dialog({content:"描述最好不要超过1024字",autoClose:!0}),!1):!0}};n.init()}),define("new",function(){});